/*
 * jQuery htmlCam
 * Version 0.1 (@edouardkombo / breezeframework.com)
 * https://github.com/edouardkombo/jquery-htmlCam
 *
 * Activate webcam, record audio and videos directly and encode them in html5 and javascript, no flash.
 *
 * Copyright (c) 2014 Edouard Kombo (@edouardkombo / breezeframework.com)
 * Dual licensed under the MIT and GPL licenses.
*/
(function(e){e.htmlCam=function(t){function m(e){if(n.startCam){r.src=window.URL.createObjectURL(e);r.attr({src:window.URL.createObjectURL(e)});o=e}if(n.enableAudioStream){var t=u.createMediaStreamSource(e);console.log("Media stream created.");var i=u.createGain();i.gain.value=0;t.connect(i);i.connect(u.destination);console.log("Input connected to muted gain node connected to audio context destination.");f=new y(t);console.log("Recorder initialised.")}}function b(){f&&f.record();console.log("Recording audio...")}function w(){f&&f.stop();E();f.clear();console.log("Stop Recording audio!")}function E(){f&&f.exportWAV(function(e){var t=URL.createObjectURL(e);var r=document.createElement("li");var i=document.createElement("audio");var s=document.createElement("a");i.controls=true;i.src=t;s.href=t;s.download=(new Date).toISOString()+".wav";s.innerHTML=s.download;r.appendChild(i);r.appendChild(s);S(e,n.onAudioComplete)})}function S(t,r){if(e.isFunction(r)){r.call(this,t,n.readyToEncode);if(e.isFunction(n.encode)){if(n.encodeCounter===0){n.encode.call(this)}n.encodeCounter++}}}function x(){function t(n){h=requestAnimationFrame(t);e("canvas").attr({width:r.width(),height:r.height()});var o=new Image;o.width=r.width();o.height=r.height();s.drawImage(r[0],0,0,r.width(),r.height());var u=i[0].toDataURL("image/webp",1);v.push(u)}v=[];p=Date.now();console.log("Recording video...");h=requestAnimationFrame(t)}function T(){cancelAnimationFrame(h);d=Date.now();console.log("frames captured: "+v.length+" => "+(d-p)/1e3+"s video");var e=Whammy.fromImageArray(v,500/60);S(e,n.onVideoComplete);console.log("Stop recording video!")}var n={startCam:true,recordingTime:0,recordAudioAndVideo:false,enableVideoStream:false,enableAudioStream:false,recorderWorkerPath:"",onAudioComplete:"null",audioTriggerButtons:"",onVideoComplete:"null",videoTriggerButtons:"",encode:"",encodeCounter:0};if(t){e.extend(n,t)}var r=e("video").length>0?e("video"):e("<video>").attr({id:"video"}).appendTo("body");r.autoplay=true;n.recordingTime=n.recordingTime*1e3;var i=e("canvas").length>0?e("canvas"):e("<canvas>").attr({id:"canvas"}).appendTo("body");var s=i[0].getContext("2d");var o=null;var u;var a=e("audio").length>0?e("audio"):e("<audio>").attr({id:"audio"}).appendTo("body");var f;var l;var c=document.title;var h=null;var p=null;var d=null;var v=[];e("canvas").attr({width:r.width(),height:r.height()});if(n.enableAudioStream){if(e.isArray(n.audioTriggerButtons)===true){if(n.recordAudioAndVideo===true){e(n.audioTriggerButtons[0]).hide();e(n.audioTriggerButtons[1]).hide()}else{e(n.audioTriggerButtons[0]).show();e(n.audioTriggerButtons[1]).hide()}e(n.audioTriggerButtons[0]).click(function(){if(n.recordingTime>0){b();e(n.audioTriggerButtons[0]).hide();var t=setInterval(function(){w();clearInterval(t);e(n.audioTriggerButtons[0]).show()},n.recordingTime)}else{b();e(n.audioTriggerButtons[0]).hide();e(n.audioTriggerButtons[1]).show()}});e(n.audioTriggerButtons[1]).click(function(){w();e(n.audioTriggerButtons[1]).hide();e(n.audioTriggerButtons[0]).show()})}else{alert("Audio buttons specification have to be array")}}if(n.enableVideoStream){if(e.isArray(n.videoTriggerButtons)===true){e(n.videoTriggerButtons[0]).show();e(n.videoTriggerButtons[1]).hide();e(n.videoTriggerButtons[0]).click(function(){if(n.recordingTime>0){if(n.recordAudioAndVideo===true&&n.enableAudioStream===true){b()}x();e(n.videoTriggerButtons[0]).hide();var t=setInterval(function(){if(n.recordAudioAndVideo===true&&n.enableAudioStream===true){w()}T();clearInterval(t);e(n.videoTriggerButtons[0]).show()},n.recordingTime)}else{x();if(n.recordAudioAndVideo===true&&n.enableAudioStream===true){b()}e(n.videoTriggerButtons[0]).hide();e(n.videoTriggerButtons[1]).show()}});e(n.videoTriggerButtons[1]).click(function(){if(n.recordAudioAndVideo===true&&n.enableAudioStream===true&&n.recordingTime<=0){w()}T();e(n.videoTriggerButtons[1]).hide();e(n.videoTriggerButtons[0]).show()})}else{alert("Video buttons specification have to be array")}}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.AudioContext=window.AudioContext||window.webkitAudioContext;window.URL=window.URL||window.webkitURL;window.onload=function(){if(n.enableAudioStream){try{u=new AudioContext;console.log("Audio context set up.");console.log("navigator.getUserMedia "+(navigator.getUserMedia?"available.":"not present!"))}catch(t){alert("No web audio support in this browser!")}}navigator.getUserMedia({audio:n.enableAudioStream,video:n.startCam},m,function(e){console.log("No live audio input or video stream: "+e)})};var g=n.recorderWorkerPath;var y=function(e,t){var n=t||{};var r=n.bufferLen||4096;this.context=e.context;this.node=this.context.createJavaScriptNode(r,2,2);var i=new Worker(n.workerPath||g);i.postMessage({command:"init",config:{sampleRate:this.context.sampleRate}});var s=false,o;this.node.onaudioprocess=function(e){if(!s)return;i.postMessage({command:"record",buffer:[e.inputBuffer.getChannelData(0),e.inputBuffer.getChannelData(1)]})};this.configure=function(e){for(var t in e){if(e.hasOwnProperty(t)){n[t]=e[t]}}};this.record=function(){s=true};this.stop=function(){s=false};this.clear=function(){i.postMessage({command:"clear"})};this.getBuffer=function(e){o=e||n.callback;i.postMessage({command:"getBuffer"})};this.exportWAV=function(e,t){o=e||n.callback;t=t||n.type||"audio/wav";if(!o)throw new Error("Callback not set");i.postMessage({command:"exportWAV",type:t})};i.onmessage=function(e){var t=e.data;o(t)};e.connect(this.node);this.node.connect(this.context.destination)};window.Recorder=y;return this}})(jQuery)